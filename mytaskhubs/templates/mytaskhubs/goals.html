{% extends "mytaskhubs/base.html" %}
{% load static %}
{% block content %}

<h2 class="titulo-pagina">Suas Metas</h2>

<!-- Mensagens / Toasts -->
{% if messages %}
  <div id="toast-container">
    {% for message in messages %}
      <div class="toast toast-{{ message.tags }}">
        {{ message }}
      </div>
    {% endfor %}
  </div>
{% endif %}

<div class="btn-and-filter">

<div class="filters">
<label for="">Filtrar Metas:</label>
<div class="filter-main">
<div class="filter-container">
  <select id="goalFilter" class="filter-select form-select">
    <option value="all">Todos</option>
    <option value="active">Em andamento</option>
    <option value="completed">Concluídos</option>
    <option value="archived">Arquivados</option>
  </select>
</div>

<div class="filter-container">
  <select id="goalFilter2" class="filter-select form-select">
  <option value="date-desc">Mais recentes</option>
  <option value="date-asc">Mais antigos</option>
  <option value="tasks-desc">Mais tasks</option>
  <option value="tasks-asc">Menos tasks</option>
</select>
</div>

<div class="filter-container">
  <select id="goalFilter3" class="filter-select form-select">
  <option value="cards">Cards</option>
  <option value="lista">Lista</option>
</select>
</div>
</div>
</div>

<a href="{% url 'new_goal' %}" class="btn">Adicionar Meta</a>

</div>

<main class="main" id="goalsContainer">
{% for goal in goals %}
<div class="card" 
     data-status="{% if goal.deleted %}archived{% elif goal.completed %}completed{% else %}active{% endif %}"
     data-tasks="{{ goal.tasks.count }}"
     data-date="{{ goal.date_added|date:'Y-m-d H:i:s' }}">
     
  <div class="card-header">
    <h4>{{ goal.title }}</h4>
  </div>

  <div class="card-body">
    <p class="card-text">{{ goal.description }}</p>
    
    <div class="card-body-status">
      <p><i class="bi bi-bullseye"></i> {{ goal.tasks.count }} tasks</p>
      {% if goal.completed %}
        <p><i class="bi bi-calendar-check"></i> Concluído</p>
      {% elif goal.deleted %}
        <p><i class="bi bi-archive"></i> Arquivado</p>
      {% else %}
        <p><i class="bi bi-calendar"></i> Em Andamento</p>
      {% endif %}
    </div>

    <div class="card-body-status-button">
      <!-- Botão Detalhes sempre visível -->
      <a href="{% url 'goal' goal.id %}" class="btn">
        Detalhes <i class="bi bi-arrow-right-short"></i>
      </a>

      <div class="card-body-status_conclude-close">
        <!-- Concluir: só aparece se não concluído nem arquivado -->
        {% if not goal.completed and not goal.deleted %}
          <form action="{% url 'concluir_goal' goal.id %}" method="post">
            {% csrf_token %}
            <button class="btn-concluir" type="submit" title="Concluir Meta">
              <i class="bi bi-toggle-off"></i>
            </button>
          </form>
        {% endif %}

        <!-- Meta concluída -->
        {% if goal.completed %}
          <a href="{% url 'goal' goal.id %}" class="btn-concluido" title="Meta Concluída">
            <i class="bi bi-toggle-on"></i>
          </a>
        {% endif %}

        <!-- Arquivar: só se não arquivado -->
        {% if not goal.deleted %}
          <button class="btn-delete" 
                  data-bs-toggle="modal" 
                  data-bs-target="#confirmArchiveModal"
                  data-url="{% url 'arquivar_goal' goal.id %}"
                  title="Arquivar Meta"> 
            <i class="bi bi-x-lg"></i>
          </button>
        {% endif %}

        <!-- Reativar: só se arquivado -->
        {% if goal.deleted %}
          <form action="{% url 'ativar_goal' goal.id %}" method="post" style="display:inline;">
            {% csrf_token %}
            <button class="btn-warning" type="submit" title="Reativar Meta">
              <i class="bi bi-arrow-counterclockwise"></i> 
            </button>
          </form>
        {% endif %}
      </div>
    </div>
  </div>
</div>
{% empty %}
<p>Nenhuma Meta foi adicionada</p>
{% endfor %}
</main>

<!-- Modal de confirmação de arquivamento -->
<div class="modal fade" id="confirmArchiveModal" tabindex="-1" aria-labelledby="confirmArchiveLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="confirmArchiveLabel"><i class="bi bi-exclamation-triangle-fill"></i> Confirmar Ação</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
      </div>
      <div class="modal-body">
        <p>Tem certeza que deseja arquivar esta meta?</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn-secondary" data-bs-dismiss="modal">Cancelar</button>
        <form id="archiveForm" method="post">
            {% csrf_token %}
            <button type="submit" class="btn-success">Sim, arquivar</button>
        </form>
      </div>
    </div>
  </div>
</div>

{% endblock content %}
